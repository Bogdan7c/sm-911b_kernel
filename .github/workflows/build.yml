name: Build S23 Kernel

on:
  workflow_dispatch: # Кнопка ручного запуска

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Очистка диска (освобождает ~30 ГБ)
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          swap-storage: false
          docker-images: false

      # 2. Скачивание твоего кода
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

# 3. Установка инструментов Linux (Исправленная версия)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential flex git libssl-dev python3 python3-pip zip unzip
          # Мы убрали проблемный lib32ncurses5-dev и заменили его на универсальный libncurses-dev
          sudo apt-get install -y libc6-dev-i386 libncurses-dev lib32z1-dev

# 4. Скачивание компилятора (Clang) - Метод Git Clone (Надежный)
      - name: Setup Toolchain
        run: |
          # Создаем папку, куда будем клонировать
          mkdir -p kernel_platform/prebuilts/clang/host/linux-x86
          
          # Используем зеркало crDroid (это точная копия официального r487747c)
          # --depth=1 означает, что мы качаем без истории (быстро, ~400МБ)
          echo "Cloning Clang r487747c..."
          git clone --depth=1 https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r487747c.git kernel_platform/prebuilts/clang/host/linux-x86/clang-r487747c
          
          # Проверяем, что всё скачалось (для логов)
          ls -la kernel_platform/prebuilts/clang/host/linux-x86/clang-r487747c/bin/clang

      # 5. Сборка (Используем твой setup_env.sh)
      - name: Build Kernel
        run: |
          # Делаем скрипты исполняемыми
          chmod +x setup_env.sh
          chmod +x kernel_platform/build/android/prepare_vendor.sh
          
          # 1. Загружаем твои правильные пути
          source ./setup_env.sh
          
          # 2. Проверяем, что пути подгрузились (будет видно в логах)
          echo "Output Dir: $OUT_DIR"
          
          # 3. Запускаем сборку
          cd kernel_platform
          RECOMPILE_KERNEL=1 BUILD_BOOT_IMG=0 ./build/android/prepare_vendor.sh sec gki

      # 6. Сохранение результата
      - name: Upload Kernel Image
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: S23-Kernel-Image
          path: |
            out/**/dist/Image
            out/**/dist/*.ko

