name: Build S23 Kernel

on:
  workflow_dispatch: # Кнопка ручного запуска

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Очистка диска (освобождает ~30 ГБ)
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          swap-storage: false
          docker-images: false

      # 2. Скачивание твоего кода
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 3. Установка инструментов Linux
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential flex git libssl-dev python3 python3-pip zip unzip
          sudo apt-get install -y libc6-dev-i386 lib32ncurses5-dev lib32z1-dev

      # 4. Скачивание компилятора (Clang)
      - name: Setup Toolchain
        run: |
          mkdir -p kernel_platform/prebuilts/clang/host/linux-x86
          cd kernel_platform/prebuilts/clang/host/linux-x86
          # Качаем Clang r487747c
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r487747c.tar.gz
          mkdir clang-r487747c
          tar -xf clang-r487747c.tar.gz -C clang-r487747c
          rm clang-r487747c.tar.gz

      # 5. Сборка (Используем твой setup_env.sh)
      - name: Build Kernel
        run: |
          # Делаем скрипты исполняемыми
          chmod +x setup_env.sh
          chmod +x kernel_platform/build/android/prepare_vendor.sh
          
          # 1. Загружаем твои правильные пути
          source ./setup_env.sh
          
          # 2. Проверяем, что пути подгрузились (будет видно в логах)
          echo "Output Dir: $OUT_DIR"
          
          # 3. Запускаем сборку
          cd kernel_platform
          RECOMPILE_KERNEL=1 BUILD_BOOT_IMG=0 ./build/android/prepare_vendor.sh sec gki

      # 6. Сохранение результата
      - name: Upload Kernel Image
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: S23-Kernel-Image
          path: |
            out/**/dist/Image
            out/**/dist/*.ko

