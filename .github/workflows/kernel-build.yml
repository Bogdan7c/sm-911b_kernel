name: SM-911B Kernel Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Build target (e.g., dm1q_eur_openx)'
        required: true
        default: 'dm1q_eur_openx'
      build_variant:
        description: 'Build variant'
        required: true
        default: 'user'
        type: choice
        options:
          - user
          - userdebug
          - eng
      chipset:
        description: 'Chipset name'
        required: true
        default: 'kalama'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential flex git libssl-dev \
            python3 python3-pip python3-setuptools \
            libncurses-dev libelf-dev liblz4-tool \
            wget curl unzip zip ccache ninja-build \
            libxml2-utils rsync
          ccache --max-size=10G

      - name: Fix script paths
        run: |
          sed -i 's|./kernel_platform/build/android/prepare_vendor.sh|./kernel_platform/build/kernel/android/prepare_vendor.sh|g' build_kernel_GKI.sh
          chmod +x build_kernel_GKI.sh setup_env.sh
          chmod +x kernel_platform/build/kernel/android/prepare_vendor.sh

      # КРИТИЧЕСКИ ВАЖНЫЙ ШАГ - ПРАВИЛЬНАЯ УСТАНОВКА NDK
      - name: Setup NDK (Correct Path)
        run: |
          echo "=== Setting up NDK r25c ==="
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          rm android-ndk-r25c-linux.zip
          
          # Создаем НУЖНУЮ структуру
          mkdir -p prebuilts/ndk
          cp -r android-ndk-r25c/* prebuilts/ndk/
          
          # Проверяем установку
          ls -la prebuilts/ndk
          echo "NDK installed successfully!"

      - name: Setup Clang Toolchain
        run: |
          echo "=== Setting up CLANG r487747c ==="
          mkdir -p kernel_platform/prebuilts/clang/host/linux-x86
          cd kernel_platform/prebuilts/clang/host/linux-x86
          git clone --depth=1 https://gitlab.com/crdroidandroid/android_prebuilts_clang_host_linux-x86_clang-r487747c.git clang-r487747c
          
          echo "CLANG_PATH=${{ github.workspace }}/kernel_platform/prebuilts/clang/host/linux-x86/clang-r487747c" >> $GITHUB_ENV
          echo "PATH=${{ github.workspace }}/kernel_platform/prebuilts/clang/host/linux-x86/clang-r487747c/bin:$PATH" >> $GITHUB_ENV
          clang --version

      - name: Build kernel
        run: |
          ./build_kernel_GKI.sh \
            ${{ inputs.build_target }} \
            ${{ inputs.build_variant }} \
            ${{ inputs.chipset }}
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sm911b-kernel-${{ github.sha }}
          path: out/msm-kernel-${{ inputs.chipset }}-gki/dist/
          retention-days: 30
