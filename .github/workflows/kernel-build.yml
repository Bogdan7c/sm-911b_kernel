name: SM-911B Kernel Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Build target (e.g., dm1q_eur_openx)'
        required: true
        default: 'dm1q_eur_openx'
      build_variant:
        description: 'Build variant'
        required: true
        default: 'user'
        type: choice
        options:
          - user
          - userdebug
          - eng
      chipset:
        description: 'Chipset name'
        required: true
        default: 'kalama'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential flex git libssl-dev \
            python3 python3-pip python3-setuptools \
            libncurses-dev libelf-dev liblz4-tool \
            wget curl unzip zip ccache ninja-build \
            libxml2-utils rsync
          ccache --max-size=10G

      - name: Fix script paths
        run: |
          sed -i 's|./kernel_platform/build/android/prepare_vendor.sh|./kernel_platform/build/kernel/android/prepare_vendor.sh|g' build_kernel_GKI.sh
          chmod +x build_kernel_GKI.sh setup_env.sh
          chmod +x kernel_platform/build/kernel/android/prepare_vendor.sh

      - name: Build kernel
        run: |
          ./build_kernel_GKI.sh \
            ${{ inputs.build_target }} \
            ${{ inputs.build_variant }} \
            ${{ inputs.chipset }}
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sm911b-kernel-${{ github.sha }}
          path: out/msm-kernel-${{ inputs.chipset }}-gki/dist/
          retention-days: 30
